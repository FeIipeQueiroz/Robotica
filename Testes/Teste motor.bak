#define INBOX 1
#define OUTBOX 5
#define BT_CONN 0
#define DEG_TO_RPM 166.6667
//distancia entre rodas 19.2
//distancia entre motores 13.5

task main(){
   long degA, degC, dist, deg_dif, dt, turn = -100;
   long prev_degA = 0, prev_degC = 0, prev_tick = 0, deltaDeg = 0;
   long francis_diam = 16.5, raio = 2.8;
   
   float rpm, AngA, AngC, deg;

   //A roda tem 56mm
   //Em uma rotação o Robô anda 17,584cm
   //Usar a função sinc, muito mais precisa
   
   SetSensorTouch(IN_1);
   

   

   while(true)
   {
      OnRevSync(OUT_AC, 50, turn);
      Wait(MS_100);
      dt = CurrentTick() - prev_tick;
      degA = MotorRotationCount(OUT_A) - prev_degA;
      degC = MotorRotationCount(OUT_C) - prev_degC;
      dist += (2*3.14*raio*abs(degA))/360;
      rpm = (abs(degA) * DEG_TO_RPM) / dt;
      AngA = ((degA)/(2*francis_diam));
      AngC = ((degC)/(2*francis_diam));
      deg = (AngA - AngC)*(180/(3.14*10));
      deltaDeg += deg;
      deg_dif = degA - degC;

      /*if(deltaDeg > 30){
        Off(OUT_AC);
        //Wait(300);
      }  */

      DrawTextType dtArgs;
      dtArgs.Location.X = 0;
      dtArgs.Location.Y = LCD_LINE1;
      dtArgs.Text = "Ang:" + NumToStr(deg);
      SysDrawText(dtArgs);
      dtArgs.Location.Y = LCD_LINE2;
      dtArgs.Text = "Dist:" + NumToStr(dist);
      SysDrawText(dtArgs);
      dtArgs.Location.Y = LCD_LINE3;
      dtArgs.Text = "DifAng:" + NumToStr(deg_dif);
      SysDrawText(dtArgs);
      dtArgs.Location.Y = LCD_LINE4;
      dtArgs.Text = "RPM:" + NumToStr(rpm);
      SysDrawText(dtArgs);
      dtArgs.Location.Y = LCD_LINE5;
      dtArgs.Text = "Ang somado:" + NumToStr(deltaDeg);
      SysDrawText(dtArgs);
      
      prev_degA = MotorRotationCount(OUT_A);
      prev_degC = MotorRotationCount(OUT_C);
      prev_tick = CurrentTick();
   }
}
